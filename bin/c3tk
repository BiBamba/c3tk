#!/usr/bin/env bash

install_cmds() {
  for _cmd in "${@}"
  do
    [[ -x ${INSTALL_PATH}/${_cmd} ]] ||
      ln -fs ${INSTALL_PATH}/c3tk ${INSTALL_PATH}/${_cmd}
  done
}

install() {
  mkdir -p "${INSTALL_PATH}" "${CONFIG_PATH}"
  cp $0 "${INSTALL_PATH}/c3tk"
  if (( $# == 0 ))
  then
    # TODO: Allow for install cmds list and/or groups to be specified
    _cmds=($(grep '^  (' $0 | tr -d '(' | tr -d ')'))
    install_cmds ${_cmds[@]}
  fi
  echo -e "Be sure to add ${INSTALL_PATH} to your path:\n\texport PATH=\"${INSTALL_PATH}:\$PATH\""
  exit 0
}

docker_run() {
  exec docker run --rm --platform="linux/amd64" -w '/w' -v ${PWD}:/w "${@}"
}

# Allow this script to be symlinked as the actual command name :)
cmd="$1"
if [[ ${0//*\/} == "c3tk" ]] 
then 
  shift
else 
  cmd="${0//*\/}"
fi

true \
  "${CONFIG_PATH:=$HOME/.config/c3tk}" \
  "${INSTALL_PREFIX:=/usr/local/bin}" \
  "${INSTALL_PATH:="${INSTALL_PREFIX}/c3tk/bin"}" \
  "${IMAGE_TAG:=latest}"

[[ ${DEBUG} == "" ]] || set -xv

# TODO: Use ~/.config/c3tk to select an upstream image, such as :version/:rc
image_for() {
  case "$1" in
    (c3tk) # CONFIG_PATH/c3tk/{image,tag}
      echo "starkandwayne/c3tk:${IMAGE_TAG}"
      ;;
    (aws) # CONFIG_PATH/aws-cli/{image,tag}
      echo "amazon/aws-cli:${IMAGE_TAG}"
      ;;
    (azure) # CONFIG_PATH/azure/{image,tag}
      echo "mcr.microsoft.com/azure-cli:${IMAGE_TAG}"
      ;;
    (gcp) # CONFIG_PATH/gcp/{image,tag}
      echo "gcr.io/google.com/cloudsdktool/cloud-sdk:${IMAGE_TAG}"
      ;;
    (govc) # CONFIG_PATH/govc/{image,tag}
      echo "vmware/govc:${IMAGE_TAG}"
      ;;
    (ruby) # CONFIG_PATH/govc/{image,tag}
      echo "ruby:${IMAGE_TAG}"
      ;;
    (terraform) # CONFIG_PATH/terraform/{image,tag}
      echo "hashicorp/terraform:${IMAGE_TAG}"
      ;;
    (terragrunt) # CONFIG_PATH/terraform/{image,tag}
      echo "alpine/terragrunt:${IMAGE_TAG}"
      ;;
    (vault) # CONFIG_PATH/vault/{image,tag}
      echo "hashicorp/vault:${IMAGE_TAG}"
      ;;
  esac
}

touch ~/.saferc ~/.vaultrc ~/.flyrc

[[ install != "${cmd}" ]] || install

case "${cmd}" in 
  (shell)
    docker_run -it \
      -v ~/:/root \
      "$(image_for c3tk)" bash "${@}"
    ;;
  (aws)
    docker_run -it \
      -v ~/.aws:/root/.aws \
      "$(image_for aws)" aws "${@}"
    ;;
  (az)
    docker_run -it \
      -v ~/.azure:/root/.azure \
      "$(image_for azure)" az "${@}"
    ;;
  (bosh)
    docker_run -it \
      -v ~/.bosh:/root/.bosh \
      "$(image_for c3tk)" bosh "${@}"
    ;;
  (cf)
    docker_run -it \
      -v :/root/.cf \
      "$(image_for c3tk)" cf "${@}"
    ;;
  (cc-me)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" cc-me "${@}"
    ;;
  (sipcalc)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" sipcalc "${@}"
    ;;
  (whois)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" whois "${@}"
    ;;
  (netcat)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" netcat "${@}"
    ;;
  (terraform)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for terraform)" terraform "${@}"
    ;;
  (terragrunt)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for terragrunt)" terragrunt "${@}"
    ;;
  (tcpdump)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" tcpdump "${@}"
    ;;
  (tig)
    docker_run -it \
      "$(image_for c3tk)" tig "${@}"
    ;;
  (nmap)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" nmap "${@}"
    ;;
  (credhub)
    docker_run -it \
      -v ~/.credhub:/root/.credhub \
      "$(image_for c3tk)" credhub "${@}"
    ;;
  (gpg)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" gpg "${@}"
    ;;
  (govc)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for govc)" /govc "${@}"
    ;;
  (genesis)
    docker_run -it \
      -v ~/.ssh:/root/.ssh \
      -v ~/.saferc:/root/.saferc \
      -v ~/.vaultrc:/root/vaultrc \
      -v ~/.credhub:/root/.credhub \
      -v ~/.bosh:/root/.bosh \
      -v ~/.cf:/root/.cf \
      "$(image_for c3tk)" genesis "${@}"
    ;;
  (gcloud)
    docker_run \
      -it \
      -v ~/.gcp:/root/.gcp \
      "$(image_for gcp)" gcloud "${@}"
    ;;
  (gsutil)
    docker_run -it \
      -v ~/.gcp:/root/.gcp \
      "$(image_for gcp)" gsutil "${@}"
    ;;
  (jq)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" jq "${@}"
    ;;
  (yq)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" yq "${@}"
    ;;
  (xq)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" xq "${@}"
    ;;
  (fly)
    docker_run -it \
      -v ~/.flyrc:/root/.flyrc \
      "$(image_for c3tk)" fly "${@}"
    ;;
  (k9s)
    docker_run -it \
      -v ~/.kube:/root/.kube \
      -v ~/.config:/root/config \
      "$(image_for c3tk)" k9s "${@}"
    ;;
  (kubectl)
    docker_run -it \
      -v ~/.kube:/root/.kube \
      "$(image_for c3tk)" kubectl "${@}"
    ;;
  (ruby)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for ruby)" ruby "${@}"
    ;;
  (spruce)
    docker_run -i \
      --log-driver=none -a stdin -a stdout -a stderr \
      "$(image_for c3tk)" spruce "${@}"
    ;;
  (safe)
    docker_run -it \
      -v ~/.saferc:/root/.saferc \
      -v ~/.vaultrc:/root/.vaultrc \
      "$(image_for c3tk)" safe "${@}"
    ;;
  (vault)
    docker_run -it \
      -v ~/.vaultrc:/root/.vaultrc \
      "$(image_for vault)" vault "${@}"
    ;;
esac

exit 0
